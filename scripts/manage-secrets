#!/usr/bin/env bash
set -euo pipefail

# Load configuration
if [[ -f .env ]]; then
    source .env
else
    echo "Missing .env file." >&2
    exit 1
fi

SECRETS_DIR=".secrets"
ENC_DIR="secrets"

mkdir -p "$SECRETS_DIR" "$ENC_DIR"

encrypt_one() {
    local name="$1"
    local plain="${SECRETS_DIR}/${name}"
    local enc="${ENC_DIR}/${name}.age"

    if [[ ! -f "$plain" ]]; then
        echo "Plaintext secret '$plain' not found." >&2
        exit 1
    fi

    local recipients_args=()
    for recipient in $AGE_RECIPIENTS; do
        recipients_args+=("-r" "$recipient")
    done

    age --encrypt "${recipients_args[@]}" "$plain" > "$enc"
    echo "Encrypted → $enc"
}

decrypt_one() {
    local name="$1"
    local plain="${SECRETS_DIR}/${name}"
    local enc="${ENC_DIR}/${name}.age"

    if [[ ! -f "$enc" ]]; then
        echo "Encrypted secret '$enc' not found." >&2
        exit 1
    fi

    age --decrypt -i "$AGE_IDENTITY" "$enc" > "$plain"
    echo "Decrypted → $plain"
}

edit_secret() {
    local name="$1"
    local enc="${ENC_DIR}/${name}.age"

    local tmp_file
    tmp_file=$(mktemp)

    # Ensure temp file is deleted on exit
    trap 'rm -f "${tmp_file:-}"' EXIT

    if [[ -f "$enc" ]]; then
        # Decrypt to temp file
        age --decrypt -i "$AGE_IDENTITY" "$enc" > "$tmp_file"
    else
        echo "Creating new secret: $name"
        touch "$tmp_file"
    fi

    # Edit temp file
    if ${EDITOR:-vi} "$tmp_file"; then
        # Re-encrypt from temp file
        local recipients_args=()
        for recipient in $AGE_RECIPIENTS; do
            recipients_args+=("-r" "$recipient")
        done

        age --encrypt "${recipients_args[@]}" "$tmp_file" > "$enc"
        echo "Updated encrypted secret: $enc"
    else
        echo "Editor exited with error, aborting update." >&2
        rm -f "$tmp_file"
        exit 1
    fi
    
    rm -f "$tmp_file"
    trap - EXIT
}

case "${1:-}" in
    encrypt)
        encrypt_one "$2"
        ;;
    decrypt)
        decrypt_one "$2"
        ;;
    edit)
        edit_secret "$2"
        ;;
    encrypt-all)
        for f in "$SECRETS_DIR"/*; do
            name=$(basename "$f")
            encrypt_one "$name"
        done
        ;;
    decrypt-all)
        for f in "$ENC_DIR"/*.age; do
            name=$(basename "$f" .age)
            decrypt_one "$name"
        done
        ;;
    *)
        echo "Usage:"
        echo "  $0 encrypt <name>"
        echo "  $0 decrypt <name>"
        echo "  $0 edit <name>        # decrypt → open EDITOR → re-encrypt"
        echo "  $0 encrypt-all"
        echo "  $0 decrypt-all"
        exit 1
        ;;
esac
